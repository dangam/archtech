<script>
    $(function(){
        // canvas
        var canvas = new fabric.Canvas('board', {
            backgroundColor: 'rgb(200,200,200)',
            width: $(document).width(),
            height: $(document).height() - 40
        });

        var src = '/uploads/' + $('#file').val();


        var canvasScale = 1;
        var SCALE_FACTOR = 1.2;
        var distX, distY;

        fabric.util.loadImage(src, function(img) {
            var object = new fabric.Image(img);
            object.set({
                left: 200,
                top: 300
            });

            var paper = new fabric.Rect({
                fill: 'white',
                width: object.get('width'),
                height: object.get('height')
            });
            paper.hasBorders = false;
            paper.hasControls = false;
            paper.lockMovementX = true;
            paper.lockMovementY = true;
            paper.lockRotation = true;
            paper.selectable = false;

            canvas.add(paper);
            canvas.centerObjectH(paper);
            canvas.centerObjectV(paper);

            object.hasRotatingPoint = true;
            canvas.add(object);
            canvas.centerObjectH(object);
            canvas.centerObjectV(object);
            canvas.renderAll();
        });

        canvas.renderAll();

        $('.upper-canvas').on('mousewheel', function(event){
            if(event.deltaY * event.deltaFactor > 0){
                zoomIn(distX, distY);
            } else {
                zoomOut();
            }
        });

        canvas.on('mouse:move', function(options) {
            var p = canvas.getPointer(options.e);
            distX = p.x;
            distY = p.y;
            canvas.renderAll();
        });


        // button Zoom In
        $("#btnZoomIn").click(function(){
            zoomIn();
        });
        // button Zoom Out
        $("#btnZoomOut").click(function(){
            zoomOut();
        });
        // button Reset Zoom
        $("#btnResetZoom").click(function(){
            resetZoom();
        });

        // Reset Zoom
        function resetZoom() {
            var objects = canvas.getObjects();
            for (var i in objects) {
                var scaleX = objects[i].scaleX;
                var scaleY = objects[i].scaleY;
                var left = objects[i].left;
                var top = objects[i].top;

                var tempScaleX = scaleX * (1 / canvasScale);
                var tempScaleY = scaleY * (1 / canvasScale);
                var tempLeft = left * (1 / canvasScale);
                var tempTop = top * (1 / canvasScale);

                objects[i].scaleX = tempScaleX;
                objects[i].scaleY = tempScaleY;
                objects[i].left = tempLeft;
                objects[i].top = tempTop;

                objects[i].setCoords();
            }

            canvas.renderAll();

            canvasScale = 1;
        };

        // Zoom In
        function zoomIn(mouseX, mouseY) {
            // TODO limit the max canvas zoom in

            canvasScale = canvasScale * SCALE_FACTOR;

            var objects = canvas.getObjects();
            for (var i in objects) {
                var scaleX = objects[i].scaleX;
                var scaleY = objects[i].scaleY;
                var left = objects[i].left;
                var top = objects[i].top;

                var tempScaleX = scaleX * SCALE_FACTOR;
                var tempScaleY = scaleY * SCALE_FACTOR;
                var tempLeft = left - ( 100 / mouseX) * SCALE_FACTOR;
                var tempTop =  top - ( 100 / mouseY) * SCALE_FACTOR;

                objects[i].scaleX = tempScaleX;
                objects[i].scaleY = tempScaleY;
                objects[i].left = tempLeft;
                objects[i].top = tempTop;

                objects[i].setCoords();
            }

            canvas.renderAll();
        };

        // Zoom Out
        function zoomOut(mouseX, mouseY) {
            // TODO limit max cavas zoom out

            canvasScale = canvasScale / SCALE_FACTOR;

            var objects = canvas.getObjects();
            for (var i in objects) {
                var scaleX = objects[i].scaleX;
                var scaleY = objects[i].scaleY;
                var left = objects[i].left;
                var top = objects[i].top;

                var tempScaleX = scaleX * (1 / SCALE_FACTOR);
                var tempScaleY = scaleY * (1 / SCALE_FACTOR);
                var tempLeft = left * (1 / SCALE_FACTOR);
                var tempTop =  top * (1 / SCALE_FACTOR);

                objects[i].scaleX = tempScaleX;
                objects[i].scaleY = tempScaleY;
                objects[i].left = tempLeft;
                objects[i].top = tempTop;

                objects[i].setCoords();
            }

            canvas.renderAll();
        };

        $( window ).resize(function() {
            canvas.setWidth($(document).width());
            canvas.setHeight($(document).height() - 40);
        });
    });
</script>